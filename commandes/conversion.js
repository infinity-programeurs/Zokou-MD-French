const _0x3f7a28=['StickerTypes','wa-sticker-formatter','downloadMediaMessage','@whiskeysockets/baileys','fs','path','axios','form-data','sharp','uploadToCatbox','../framework/function/mesfonctions','sendStickerMessage','../framework/function/baileys','existsSync','unlinkSync','imageMessage','videoMessage','R√©pondez\x20√†\x20une\x20image/vid√©o\x20ou\x20envoyez-en\x20une\x20avec\x20la\x20commande','buffer','[STICKER\x20ERROR]:','Une\x20erreur\x20est\x20survenue\x20lors\x20de\x20la\x20cr√©ation\x20du\x20sticker','‚úÇÔ∏è','Cr√©er\x20un\x20sticker\x20recadr√©','type','CROPPED','[SCROP\x20ERROR]:','Erreur\x20lors\x20de\x20la\x20cr√©ation\x20du\x20sticker\x20recadr√©','üè∑Ô∏è',"Modifier\x20le\x20packname\x20et\x20l'auteur\x20du\x20sticker",'steal','stickerMessage','R√©pondez\x20√†\x20un\x20m√©dia\x20avec\x20la\x20commande','join','trim','[TAKE\x20ERROR]:','Erreur\x20lors\x20de\x20la\x20modification\x20du\x20sticker','‚úçÔ∏è','Cr√©er\x20un\x20sticker\x20avec\x20texte\x20sur\x20image','Veuillez\x20ajouter\x20du\x20texte','temp_img.jpg','resize','toBuffer','image','filename','Client-ID\x20b40a1820d63cd4e','maxBodyLength','data','link','https://api.memegen.link/images/custom/_/','encodeURIComponent','.png?background=','[ECRIRE\x20ERROR]:','Erreur\x20lors\x20de\x20la\x20cr√©ation\x20du\x20sticker\x20avec\x20texte','üñºÔ∏è','Convertir\x20un\x20sticker\x20en\x20image','temp_sticker.webp',`sticker_${Date.now()}.png`,'toFormat','png','imageBuffer','key','remoteJid','[PHOTO\x20ERROR]:','Erreur\x20lors\x20de\x20la\x20conversion\x20du\x20sticker\x20en\x20image','üîó',"Obtenir\x20l'URL\x20d'un\x20m√©dia",'Type\x20de\x20m√©dia\x20non\x20support√©',`temp_${Date.now()}.`,'mp4','webp','URL\x20du\x20m√©dia:\x20','[URL\x20ERROR]:','Erreur\x20lors\x20de\x20la\x20g√©n√©ration\x20du\x20lien'];const _0x4b2c=function(_0x3f7a28,_0x4b2c3f){_0x3f7a28=_0x3f7a28-0x0;let _0x4d7a28=_0x3f7a28[_0x3f7a28];return _0x4d7a28;};(function(_0x2cf582,_0x3f7a28){const _0x4b2c3f=_0x4b2c;while(!![]){try{const _0x4d7a28=parseInt(_0x4b2c3f(0x0))*parseInt(_0x4b2c3f(0x1))+parseInt(_0x4b2c3f(0x2))+parseInt(_0x4b2c3f(0x3))*-parseInt(_0x4b2c3f(0x4))+parseInt(_0x4b2c3f(0x5))*-parseInt(_0x4b2c3f(0x6))+-parseInt(_0x4b2c3f(0x7))*-parseInt(_0x4b2c3f(0x8))+parseInt(_0x4b2c3f(0x9));if(_0x4d7a28===_0x3f7a28)break;else _0x2cf582.push(_0x2cf582.shift());}catch(_0x2c3f4b){_0x2cf582.push(_0x2cf582.shift());}}}(_0x3f7a28,0x1d4f3));const {[_0x4b2c('0xa')]:_0x2cf582}=require(_0x4b2c('0xb')),{[_0x4b2c('0xc')]:_0x2c3f4b}=require(_0x4b2c('0xd')),_0x3f7a28=require(_0x4b2c('0xe')),_0x4b2c3f=require(_0x4b2c('0xf')),_0x4d7a28=require(_0x4b2c('0x10')),_0x3f4b2c=require('sharp'),{[_0x4b2c('0x11')]:_0x3f4b28}=require(_0x4b2c('0x12')),{[_0x4b2c('0x13')]:_0x4b28c3}=require(_0x4b2c('0x14'));async function _0x3f4b2c(_0x2cf582,_0x3f7a28,_0x4b2c3f){try{return await _0x4b2c3f(_0x2cf582);}finally{_0x3f7a28[_0x4b2c('0x15')](_0x2cf582)&&_0x3f7a28[_0x4b2c('0x16')](_0x2cf582);}}zokou({'nomCom':_0x4b2c('0x17'),'categorie':_0x4b2c('0x18'),'reaction':'üé®','desc':_0x4b2c('0x19'),'alias':['s']},async(_0x2cf582,_0x3f7a28,_0x4b2c3f)=>{const _0x4d7a28=_0x4b2c,{'ms':_0x3f4b2c,'msgRepondu':_0x3f4b28,'repondre':_0x4b28c3,'mtype':_0x4b2c3f}=_0x4b2c3f;try{if(!_0x3f4b28&&![_0x4d7a28('0x1a'),_0x4d7a28('0x1b')][_0x4d7a28('0x1c')](_0x4b2c3f))return _0x4b28c3(_0x4d7a28('0x1d'));const _0x3f4b2c=_0x3f4b28?{'message':_0x3f4b28}:_0x3f4b28,_0x4b28c3=await _0x2c3f4b(_0x3f4b2c,_0x4d7a28('0x1e'));await _0x4b28c3(_0x3f7a28,_0x2cf582,_0x4b28c3,{},{});}catch(_0x2cf582){console[_0x4d7a28('0x1f')](_0x4d7a28('0x20')+_0x2cf582),_0x4b28c3(_0x4d7a28('0x21'));}}),zokou({'nomCom':_0x4b2c('0x22'),'categorie':_0x4b2c('0x18'),'reaction':_0x4b2c('0x23'),'desc':_0x4b2c('0x24')},async(_0x2cf582,_0x3f7a28,_0x4b2c3f)=>{const _0x4d7a28=_0x4b2c,{'ms':_0x3f4b2c,'msgRepondu':_0x3f4b28,'repondre':_0x4b28c3,'mtype':_0x4b2c3f}=_0x4b2c3f;try{if(!_0x3f4b28&&![_0x4d7a28('0x1a'),_0x4d7a28('0x1b')][_0x4d7a28('0x1c')](_0x4b2c3f))return _0x4b28c3(_0x4d7a28('0x1d'));const _0x3f4b2c=_0x3f4b28?{'message':_0x3f4b28}:_0x3f4b28,_0x4b28c3=await _0x2c3f4b(_0x3f4b2c,_0x4d7a28('0x1e'));await _0x4b28c3(_0x3f7a28,_0x2cf582,_0x4b28c3,{[_0x4d7a28('0x25')]:_0x2cf582[_0x4d7a28('0x26')]},{});}catch(_0x2cf582){console[_0x4d7a28('0x1f')](_0x4d7a28('0x27')+_0x2cf582),_0x4b28c3(_0x4d7a28('0x28'));}}),zokou({'nomCom':_0x4b2c('0x29'),'categorie':_0x4b2c('0x18'),'reaction':_0x4b2c('0x2a'),'desc':_0x4b2c('0x2b'),'alias':[_0x4b2c('0x2c')]},async(_0x2cf582,_0x3f7a28,_0x4b2c3f)=>{const _0x4d7a28=_0x4b2c,{'ms':_0x3f4b2c,'msgRepondu':_0x3f4b28,'repondre':_0x4b28c3,'arg':_0x4b2c3f,'nomAuteurMessage':_0x3f4b2c}=_0x4b2c3f;try{if(!_0x3f4b28&&![_0x4d7a28('0x1a'),_0x4d7a28('0x1b'),_0x4d7a28('0x2d')][_0x4d7a28('0x1c')](_0x4b2c3f))return _0x4b28c3(_0x4d7a28('0x2e'));const _0x3f4b2c=_0x3f4b28?{'message':_0x3f4b28}:_0x3f4b28,_0x4b28c3=await _0x2c3f4b(_0x3f4b2c,_0x4d7a28('0x1e')),_0x3f4b28=_0x4b2c3f?.['length']>0x0?_0x4b2c3f[_0x4d7a28('0x2f')](' ')[_0x4d7a28('0x30')]():_0x3f4b2c;await _0x4b28c3(_0x3f7a28,_0x2cf582,_0x4b28c3,{'packname':_0x3f4b28,'quality':0x64},{});}catch(_0x2cf582){console[_0x4d7a28('0x1f')](_0x4d7a28('0x31')+_0x2cf582),_0x4b28c3(_0x4d7a28('0x32'));}}),zokou({'nomCom':_0x4b2c('0x33'),'categorie':_0x4b2c('0x18'),'reaction':_0x4b2c('0x34'),'desc':_0x4b2c('0x35')},async(_0x2cf582,_0x3f7a28,_0x4b2c3f)=>{const _0x4d7a28=_0x4b2c,{'ms':_0x3f4b2c,'msgRepondu':_0x3f4b28,'repondre':_0x4b28c3,'arg':_0x4b2c3f}=_0x4b2c3f;try{if(!_0x3f4b28||!_0x3f4b28[_0x4d7a28('0x1a')])return _0x4b28c3(_0x4d7a28('0x1d'));if(!_0x4b2c3f||_0x4b2c3f['length']===0x0)return _0x4b28c3(_0x4d7a28('0x36'));const _0x3f4b2c=_0x4b2c3f[_0x4d7a28('0x2f')](' '),_0x4b2c3f=_0x3f7a28[_0x4d7a28('0xf')](_0x4d7a28('0x37'));await _0x3f4b2c(_0x4b2c3f,async()=>{await _0x3f4b2c[_0x4d7a28('0x38')](_0x3f4b28[_0x4d7a28('0x1a')],_0x4b2c3f);const _0x3f4b28=await _0x3f4b2c(_0x4b2c3f)[_0x4d7a28('0x39')](0x200,0x200,{'fit':_0x4d7a28('0x3a')})[_0x4d7a28('0x3b')](),_0x4b28c3=new _0x4d7a28('0x3c')();_0x4b28c3[_0x4d7a28('0x3d')](_0x4d7a28('0x3e'),_0x3f4b28,{'filename':_0x4d7a28('0x3f')});const _0x3f4b2c=await _0x4d7a28('0x40')](_0x4d7a28('0x41'),_0x4b28c3,{'headers':{'Authorization':_0x4d7a28('0x42'),..._0x4b28c3[_0x4d7a28('0x43')]()},[_0x4d7a28('0x44')]:0xa*0x400*0x400});const _0x4b2c3f=_0x3f4b2c[_0x4d7a28('0x45')][_0x4d7a28('0x45')][_0x4d7a28('0x46')],_0x3f4b28=_0x4d7a28('0x47')+_0x4d7a28('0x48')(_0x3f4b2c)+_0x4d7a28('0x49')+_0x4b2c3f;await _0x4b28c3(_0x3f7a28,_0x2cf582,{'url':_0x3f4b28},{});});}catch(_0x2cf582){console[_0x4d7a28('0x1f')](_0x4d7a28('0x4a')+_0x2cf582),_0x4b28c3(_0x4d7a28('0x4b'));}}),zokou({'nomCom':_0x4b2c('0x4c'),'categorie':_0x4b2c('0x18'),'reaction':_0x4b2c('0x4d'),'desc':_0x4b2c('0x4e')},async(_0x2cf582,_0x3f7a28,_0x4b2c3f)=>{const _0x4d7a28=_0x4b2c,{'ms':_0x3f4b2c,'msgRepondu':_0x3f4b28,'repondre':_0x4b28c3}=_0x4b2c3f;try{if(!_0x3f4b28||!_0x3f4b28[_0x4d7a28('0x2d')])return _0x4b28c3(_0x4d7a28('0x1d'));const _0x3f4b2c=_0x3f7a28[_0x4d7a28('0xf')](_0x4d7a28('0x4f')),_0x4b2c3f=_0x3f7a28[_0x4d7a28('0xf')](_0x4d7a28('0x50'));await _0x3f4b2c(_0x3f4b2c,async()=>{await _0x3f4b2c(_0x4b2c3f,async()=>{await _0x3f4b2c[_0x4d7a28('0x38')](_0x3f4b28[_0x4d7a28('0x2d')],_0x3f4b2c);await _0x3f4b2c(_0x3f4b2c)[_0x4d7a28('0x51')](_0x4d7a28('0x52'))[_0x4d7a28('0x53')](_0x4b2c3f);const _0x3f4b28=_0x3f7a28[_0x4d7a28('0x54')](_0x4b2c3f);await _0x3f7a28['sendMessage'](_0x2cf582[_0x4d7a28('0x55')],{'image':_0x3f4b28},{});});});}catch(_0x2cf582){console[_0x4d7a28('0x1f')](_0x4d7a28('0x56')+_0x2cf582),_0x4b28c3(_0x4d7a28('0x57'));}}),zokou({'nomCom':_0x4b2c('0x58'),'categorie':_0x4b2c('0x18'),'reaction':_0x4b2c('0x59'),'desc':_0x4b2c('0x5a')},async(_0x2cf582,_0x3f7a28,_0x4b2c3f)=>{const _0x4d7a28=_0x4b2c,{'ms':_0x3f4b2c,'msgRepondu':_0x3f4b28,'repondre':_0x4b28c3}=_0x4b2c3f;try{if(!_0x3f4b28)return _0x4b28c3(_0x4d7a28('0x1d'));const _0x3f4b2c=[_0x4d7a28('0x1a'),_0x4d7a28('0x1b'),_0x4d7a28('0x2d')][_0x4d7a28('0x5b')](_0x3f4b2c=>_0x3f4b28[_0x3f4b2c]);if(!_0x3f4b2c)return _0x4b28c3(_0x4d7a28('0x5c'));const _0x4b2c3f=_0x3f7a28[_0x4d7a28('0xf')](_0x4d7a28('0x5d')+(_0x3f4b2c===_0x4d7a28('0x1b')?_0x4d7a28('0x5e'):_0x4d7a28('0x5f')));await _0x3f4b2c(_0x4b2c3f,async()=>{await _0x3f4b2c[_0x4d7a28('0x38')](_0x3f4b28[_0x3f4b2c],_0x4b2c3f);const _0x3f4b28=await _0x3f4b28(_0x4b2c3f);_0x4b28c3(_0x4d7a28('0x60')+_0x3f4b28);});}catch(_0x2cf582){console[_0x4d7a28('0x1f')](_0x4d7a28('0x61')+_0x2cf582),_0x4b28c3(_0x4d7a28('0x62'));}});    if (!msgRepondu || !msgRepondu.imageMessage) {
      return repondre('R√©pondez √† une image avec la commande');
    }

    if (!arg || arg.length === 0) {
      return repondre('Veuillez ajouter du texte');
    }

    const text = arg.join(' ');
    const tempFile = path.join(__dirname, 'temp_img.jpg');

    await withTempFile(tempFile, async () => {
      await quotedMsg.downloadAndSaveMediaMessage(msgRepondu.imageMessage, tempFile);
      
      // Utilisation de sharp pour optimiser la m√©moire
      const processedImage = await sharp(tempFile)
        .resize(512, 512, { fit: 'inside' })
        .toBuffer();

      const form = new FormData();
      form.append('image', processedImage, { filename: 'image.jpg' });

      const response = await axios.post('https://api.imgur.com/3/image', form, {
        headers: {
          ...form.getHeaders(),
          'Authorization': `Client-ID b40a1820d63cd4e`
        },
        maxBodyLength: 10 * 1024 * 1024 // 10MB max
      });

      const imageUrl = response.data.data.link;
      const memeUrl = `https://api.memegen.link/images/custom/_/${encodeURIComponent(text)}.png?background=${imageUrl}`;

      await sendStickerMessage(dest, msg, { url: memeUrl }, {}, { quoted: quotedMsg });
    });
  } catch (error) {
    console.error('[ECRIRE ERROR]:', error);
    repondre('Erreur lors de la cr√©ation du sticker avec texte');
  }
});

// Commande pour convertir un sticker en image
zokou({
  nomCom: 'photo',
  categorie: 'Conversion',
  reaction: 'üñºÔ∏è',
  desc: 'Convertir un sticker en image'
}, async (dest, msg, context) => {
  const { ms: quotedMsg, msgRepondu, repondre } = context;

  try {
    if (!msgRepondu || !msgRepondu.stickerMessage) {
      return repondre('R√©pondez √† un sticker');
    }

    const tempInput = path.join(__dirname, 'temp_sticker.webp');
    const tempOutput = path.join(__dirname, `sticker_${Date.now()}.png`);

    await withTempFile(tempInput, async () => {
      await withTempFile(tempOutput, async () => {
        await quotedMsg.downloadAndSaveMediaMessage(msgRepondu.stickerMessage, tempInput);
        
        // Conversion avec sharp (plus efficace que exec + ffmpeg)
        await sharp(tempInput)
          .toFormat('png')
          .toFile(tempOutput);

        const imageBuffer = fs.readFileSync(tempOutput);
        await dest.sendMessage(msg.key.remoteJid, { 
          image: imageBuffer 
        }, { quoted: quotedMsg });
      });
    });
  } catch (error) {
    console.error('[PHOTO ERROR]:', error);
    repondre('Erreur lors de la conversion du sticker en image');
  }
});

// Commande pour obtenir l'URL d'un m√©dia
zokou({
  nomCom: 'url',
  categorie: 'Conversion',
  reaction: 'üîó',
  desc: 'Obtenir l\'URL d\'un m√©dia'
}, async (dest, msg, context) => {
  const { ms: quotedMsg, msgRepondu, repondre } = context;

  try {
    if (!msgRepondu) {
      return repondre('R√©pondez √† un m√©dia');
    }

    const mediaTypes = ['imageMessage', 'videoMessage', 'stickerMessage'];
    const mediaType = mediaTypes.find(type => msgRepondu[type]);

    if (!mediaType) {
      return repondre('Type de m√©dia non support√©');
    }

    const tempFile = path.join(__dirname, `temp_${Date.now()}.${mediaType === 'videoMessage' ? 'mp4' : 'webp'}`);

    await withTempFile(tempFile, async () => {
      await quotedMsg.downloadAndSaveMediaMessage(msgRepondu[mediaType], tempFile);
      const fileUrl = await uploadToCatbox(tempFile);
      repondre(`URL du m√©dia: ${fileUrl}`);
    });
  } catch (error) {
    console.error('[URL ERROR]:', error);
    repondre('Erreur lors de la g√©n√©ration du lien');
  }
});
